---
title: "Extreme Gradient Boosting Model"
output:
  html_notebook:
    code_folding: hide
    number_sections: yes
    toc: yes
    toc_depth: 6
    toc_float: yes
date: "`r format(Sys.time(), '%a %b %d %Y %X')`"
---

# Preparing Data

## Loading necessary packages

We must load the package `Laurae`, `data.table`, `rmarkdown`, `RcppArmadillo`, `DT`, `formattable`, `matrixStats`, and `lattice` before continuing.

```{r Packages}
library(Laurae)
library(data.table)
library(rmarkdown)
library(xgboost)
library(DT)
library(formattable)
library(matrixStats)
library(lattice)
library(R.utils)
```

## Print-A-Lot

We are going to print a lot. Therefore, we must go over the limitations of R.

```{r PrePrint}
previousLimit <- getOption("max.print")
previousScipen <- getOption("scipen")
options(max.print = 1e7)
options(scipen = 999)
my_data <- copy(data)
```

## Data Normalization (normalize = `r normalize`)

The features can be normalized to the range [0, 1\].

```{r Normalize}
if (normalize) {
  for (i in 1:ncol(data)) {
    my_data[[i]] <- (my_data[[i]] - min(my_data[[i]], na.rm = TRUE)) / (max(my_data[[i]], na.rm = TRUE) - min(my_data[[i]], na.rm = TRUE))
  }
}
```

# Creating the Regression Model

We are generating the regression model per fold.

```{r Train}
fitted_xgb <- list()
fitted_values <- list()
fitted_predicted <- list()
fitted_pre_importance <- list()
fitted_post_importance <- list()

StartTime <- timer()
CurrentTime <- StartTime
for (i in 1:length(folds)) {
  data_temp <- DTsubsample(my_data, kept = folds[[i]], remove = TRUE, low_mem = FALSE, collect = 50, silent = TRUE)
  label_temp <- label[-folds[[i]]]
  data_temp1 <- xgb.DMatrix(data = DT2mat(data_temp, low_mem = FALSE, collect = 50, silent = TRUE), label = label_temp)
  data_temp <- DTsubsample(my_data, kept = folds[[i]], remove = FALSE, low_mem = FALSE, collect = 50, silent = TRUE)
  label_temp <- label[folds[[i]]]
  data_temp2 <- xgb.DMatrix(data = DT2mat(data_temp, low_mem = FALSE, collect = 50, silent = TRUE), label = label_temp)
  fitted_xgb[[i]] <- report.xgb.helper(data_temp1, data_temp2, params)
  fitted_values[[i]] <- label_temp
  fitted_predicted[[i]] <- predict(fitted_xgb[[i]], data_temp2, ntreelimit = fitted_xgb$best_iteration)
  if (importance) {
    fitted_pre_importance[[i]] <- xgb.importance(model = fitted_xgb[[i]], feature_names = colnames(my_data))
    if (unbiased) {
      fitted_xgb[[i]] <- report.xgb.helper(data_temp1, data_temp2, params, fitted_xgb[[i]]$best_iteration)
      rparams <- modifyList(params, list(process_type = "update", updater = "refresh", refresh_leaf = FALSE))
      fitted_xgb[[i]] <- report.xgb.helper(data_temp1, data_temp2, rparams, fitted_xgb[[i]]$best_iteration, fitted_xgb[[i]])
      fitted_post_importance[[i]] <- xgb.importance(model = fitted_xgb[[i]], feature_names = colnames(my_data))
    }
  }
  rm(data_temp, label_temp, data_temp1, data_temp2)
  gc(verbose = FALSE)
  cat("[", format(Sys.time(), "%a %b %d %Y %X"), "] Fitted the xgboost model on fold ", sprintf(paste0("%0", floor(log10(length(folds))) + 1, "d"), i), " in ", sprintf("%07.03f", (timer() - CurrentTime) / 1000), "s.  \n", sep = "")
  CurrentTime <- timer()
}
```

# Aggregated Regression Statistics (out of fold)

We must gather all values first.

```{r Validate}
if (!classification) {
  fitted_diff <- list()
  fitted_sqdiff <- list()
  r_pearson <- numeric(length(folds))
  r_spearman <- numeric(length(folds))
  r_squared <- numeric(length(folds))
  r_mae <- numeric(length(folds))
  r_mse <- numeric(length(folds))
  r_rmse <- numeric(length(folds))
  r_mape <- numeric(length(folds))
} else {
  r_auc <- numeric(length(folds))
  r_logloss <- numeric(length(folds))
  r_kappa <- numeric(length(folds))
  r_kappa_p <- numeric(length(folds))
  r_f1s <- numeric(length(folds))
  r_f1s_p <- numeric(length(folds))
  r_mcc <- numeric(length(folds))
  r_mcc_p <- numeric(length(folds))
  r_tpr <- numeric(length(folds))
  r_tpr_p <- numeric(length(folds))
  r_tnr <- numeric(length(folds))
  r_tnr_p <- numeric(length(folds))
  r_fpr <- numeric(length(folds))
  r_fpr_p <- numeric(length(folds))
  r_fnr <- numeric(length(folds))
  r_fnr_p <- numeric(length(folds))
}

if (! classification) {
  for (i in 1:length(folds)) {
    fitted_diff[[i]] <- abs(fitted_values[[i]] - fitted_predicted[[i]])
    fitted_sqdiff[[i]] <- fitted_diff[[i]] * fitted_diff[[i]]
    r_pearson[i] <- cor(data.frame(A = fitted_values[[i]], B = fitted_predicted[[i]]), method = "pearson")[1, 2]
    r_squared[i] <- r_pearson[i] * r_pearson[i]
    r_mae[i] <- mean(fitted_diff[[i]])
    r_mse[i] <- mean(fitted_sqdiff[[i]])
    r_rmse[i] <- sqrt(r_mse[i])
    r_mape[i] <- mean(fitted_diff[[i]] / fitted_values[[i]])
    gc(verbose = FALSE)
  }
} else {
  for (i in 1:length(folds)) {
    r_auc[[i]] <- FastROC(fitted_predicted[[i]], fitted_values[[i]])
    r_logloss[[i]] <- LogLoss(fitted_predicted[[i]], fitted_values[[i]])
    temp_vec <- get.max_kappa(fitted_predicted[[i]], fitted_values[[i]])
    r_kappa[[i]] <- temp_vec[1]
    r_kappa_p[[i]] <- temp_vec[2]
    temp_vec <- get.max_f1(fitted_predicted[[i]], fitted_values[[i]])
    r_f1s[[i]] <- temp_vec[1]
    r_f1s_p[[i]] <- temp_vec[2]
    temp_vec <- get.max_mcc(fitted_predicted[[i]], fitted_values[[i]])
    r_mcc[[i]] <- temp_vec[1]
    r_mcc_p[[i]] <- temp_vec[2]
    temp_vec <- get.max_sensitivity(fitted_predicted[[i]], fitted_values[[i]])
    r_tpr[[i]] <- temp_vec[1]
    r_tpr_p[[i]] <- temp_vec[2]
    temp_vec <- get.max_specificity(fitted_predicted[[i]], fitted_values[[i]])
    r_tnr[[i]] <- temp_vec[1]
    r_tnr_p[[i]] <- temp_vec[2]
    temp_vec <- get.max_fallout(fitted_predicted[[i]], fitted_values[[i]])
    r_fpr[[i]] <- temp_vec[1]
    r_fpr_p[[i]] <- temp_vec[2]
    temp_vec <- get.max_missrate(fitted_predicted[[i]], fitted_values[[i]])
    r_fnr[[i]] <- temp_vec[1]
    r_fnr_p[[i]] <- temp_vec[2]
    gc(verbose = FALSE)
  }
}

```

## Base Statistics, global (stats = `r stats`)

A pretty table is better than text to print the base statistics.

```{r Stats1}
if (stats) {
  if (!classification) {
    stats_table <- data.table(Statistic = c("Pearson Correlation Coefficient (R)", "Coefficient of Determination (R^2)", "Mean Absolute Error (MAE)", "Mean Squared Error (MSE)", "Root Mean Squared Error (RMSE)", "Mean Average Percentage Error (MAPE)"), Mean = c(mean(r_pearson), mean(r_squared), mean(r_mae), mean(r_mse), mean(r_rmse), mean(r_mape)), SD = c(sd(r_pearson), sd(r_squared), sd(r_mae), sd(r_mse), sd(r_rmse), sd(r_mape)))
    formattable(stats_table)
  } else {
    stats_table <- data.table(Statistic = c("AUROC", "Log Loss", "Kappa", "F1 Score", "MCC", "TPR", "TNR", "FPR", "FNR"), Mean = c(mean(r_auc), mean(r_logloss), mean(r_kappa), mean(r_f1s), mean(r_mcc), mean(r_tpr), mean(r_tnr), mean(r_fpr), mean(r_fnr)), SD = c(sd(r_auc), sd(r_logloss), sd(r_kappa), sd(r_f1s), sd(r_mcc), sd(r_tpr), sd(r_tnr), sd(r_fpr), sd(r_fnr)))
    formattable(stats_table)
    stats_probs <- data.table(Statistic = c("Kappa", "F1 Score", "MCC", "TPR", "TNR", "FPR", "FNR"), Mean = c(mean(r_kappa_p), mean(r_f1s_p), mean(r_mcc_p), mean(r_tpr_p), mean(r_tnr_p), mean(r_fpr_p), mean(r_fnr_p)), SD = c(sd(r_kappa_p), sd(r_f1s_p), sd(r_mcc_p), sd(r_tpr_p), sd(r_tnr_p), sd(r_fpr_p), sd(r_fnr_p)))
    formattable(stats_probs)
  }
}
```

## Base Statistics (per fold) (stats = `r stats`)

A pretty table is better than text to print the base statistics. For classification, the metrics are the most optimistic values.

```{r Stats2}
if (stats) {
  if (!classification) {
    stats_table <- data.table(Folds = 1:length(folds), R = r_pearson, R2 = r_squared, MAE = r_mae, MSE = r_mse, RMSE = r_rmse, MAPE = r_mape)
    stats_probs <- NULL
    formattable(stats_table, list(R = color_bar("lightpink"), R2 = color_bar("pink"), MAE = color_bar("lightgreen"), MSE = color_bar("lightgrey"), RMSE = color_bar("lightblue"), MAPE = color_bar("cyan")))
  } else {
    stats_table <- data.table(Folds = 1:length(folds), AUROC = r_auc, LogLoss = r_logloss, Kappa = r_kappa, F1_Score = r_f1s, MCC = r_mcc, TPR = r_tpr, TNR = r_tnr, FPR = r_fpr, FNR = r_fnr)
    formattable(stats_table, list(AUROC = color_bar("lightpink"), LogLoss = color_bar("pink"), Kappa = color_bar("lightgreen"), F1_Score = color_bar("lightgreen"), MCC = color_bar("lightgreen"), TPR = color_bar("lightblue"), TNR = color_bar("lightblue"), FPR = color_bar("cyan"), FPR = color_bar("cyan")))
    stats_probs <- data.table(Folds = 1:length(folds), pKappa = r_kappa_p, pF1_Score = r_f1s_p, pMCC = r_mcc_p, pTPR = r_tpr_p, pTNR = r_tnr_p, pFPR = r_fpr_p, pFNR = r_fnr_p)
    formattable(stats_probs, list(pKappa = color_bar("lightgreen"), pF1_Score = color_bar("lightgreen"), pMCC = color_bar("lightgreen"), pTPR = color_bar("lightblue"), pTNR = color_bar("lightblue"), pFPR = color_bar("cyan"), pFPR = color_bar("cyan"), pFNR = color_bar("cyan")))
  }
}
```

## Feature Importance (importance = `r importance`, unbiased = `r unbiased`)

```{r FeatureImp}
if (importance) {
  if (!unbiased) {
    fitted_importance <- fitted_pre_importance[[1]]
    for (i in 2:length(folds)) {
      fitted_importance <- DTrbind(fitted_importance, fitted_pre_importance[[i]])
    }
    fitted_importance <- fitted_importance[, list(Gain_Mean = mean(Gain), Gain_SD = sd(Gain), Cover_Mean = mean(Cover), Cover_SD = sd(Cover), Freq_Mean = mean(Frequency), Freq_SD = sd(Frequency)), by = Feature]
    
    datatable(fitted_importance,
              filter = "top",
              class = "cell-border stripe",
              options = list(pageLength = 10,
                             lengthMenu = c(5, 10, 15, 20, 25, 50, 100, 500))
    ) %>% formatStyle("Gain_Mean",
                      background = styleColorBar(range(fitted_importance$Gain_Mean, na.rm = TRUE, finite = TRUE), "lightgreen"),
                      backgroundSize = '100% 90%',
                      backgroundRepeat = 'no-repeat',
                      backgroundPosition = 'center') %>%
      formatStyle("Cover_Mean",
                  background = styleColorBar(range(fitted_importance$Cover_Mean, na.rm = TRUE, finite = TRUE), "lightblue"),
                  backgroundSize = '100% 90%',
                  backgroundRepeat = 'no-repeat',
                  backgroundPosition = 'center') %>%
      formatStyle("Freq_Mean",
                  background = styleColorBar(range(fitted_importance$Freq_Mean, na.rm = TRUE, finite = TRUE), "lightgrey"),
                  backgroundSize = '100% 90%',
                  backgroundRepeat = 'no-repeat',
                  backgroundPosition = 'center') %>%
      formatStyle("Gain_SD",
                  background = styleColorBar(range(fitted_importance$Gain_SD, na.rm = TRUE, finite = TRUE), "pink"),
                  backgroundSize = '100% 90%',
                  backgroundRepeat = 'no-repeat',
                  backgroundPosition = 'center') %>%
      formatStyle("Cover_SD",
                  background = styleColorBar(range(fitted_importance$Cover_SD, na.rm = TRUE, finite = TRUE), "pink"),
                  backgroundSize = '100% 90%',
                  backgroundRepeat = 'no-repeat',
                  backgroundPosition = 'center') %>%
      formatStyle("Freq_SD",
                  background = styleColorBar(range(fitted_importance$Freq_SD, na.rm = TRUE, finite = TRUE), "pink"),
                  backgroundSize = '100% 90%',
                  backgroundRepeat = 'no-repeat',
                  backgroundPosition = 'center') %>%
      formatPercentage(columns = c("Gain_Mean", "Gain_SD", "Cover_Mean", "Cover_SD", "Freq_Mean", "Freq_SD"),
                       digits = 6)
  } else {
    fitted_importance1 <- fitted_pre_importance[[1]]
    fitted_importance2 <- fitted_post_importance[[1]]
    for (i in 2:length(folds)) {
      fitted_importance1 <- DTrbind(fitted_importance1, fitted_pre_importance[[i]])
      fitted_importance2 <- DTrbind(fitted_importance2, fitted_post_importance[[i]])
    }
    fitted_importance1 <- fitted_importance1[, list(BGainM = mean(Gain), BGainSD = sd(Gain), BCoverM = mean(Cover), BCoverSD = sd(Cover), FreqM = mean(Frequency), FreqSD = sd(Frequency)), by = Feature]
    fitted_importance2 <- fitted_importance2[, list(UGainM = mean(Gain), UGainSD = sd(Gain), UCoverM = mean(Cover), UCoverSD = sd(Cover)), by = Feature]
    fitted_importance <- merge(fitted_importance2, fitted_importance1, by = "Feature", sort = FALSE)
    setcolorder(fitted_importance, c(1, 6, 2, 7, 3, 8, 4, 9, 5, 10, 11))
    fitted_importance[["UGainM"]] <- fitted_importance[["UGainM"]] - fitted_importance[["BGainM"]]
    fitted_importance[["UCoverM"]] <- fitted_importance[["UCoverM"]] - fitted_importance[["BCoverM"]]
    
    datatable(fitted_importance,
              filter = "top",
              class = "cell-border stripe",
              options = list(pageLength = 10,
                             lengthMenu = c(5, 10, 15, 20, 25, 50, 100, 500))
    ) %>% formatStyle("BGainM",
                      background = styleColorBar(range(fitted_importance$BGainM, na.rm = TRUE, finite = TRUE), "lightgreen"),
                      backgroundSize = '100% 90%',
                      backgroundRepeat = 'no-repeat',
                      backgroundPosition = 'center') %>%
      formatStyle("UGainM",
                  background = styleColorBar(range(fitted_importance$UGainM, na.rm = TRUE, finite = TRUE), "lightgreen"),
                  backgroundSize = '100% 90%',
                  backgroundRepeat = 'no-repeat',
                  backgroundPosition = 'center') %>%
      formatStyle("BCoverM",
                  background = styleColorBar(range(fitted_importance$BCoverM, na.rm = TRUE, finite = TRUE), "lightblue"),
                  backgroundSize = '100% 90%',
                  backgroundRepeat = 'no-repeat',
                  backgroundPosition = 'center') %>%
      formatStyle("UCoverM",
                  background = styleColorBar(range(fitted_importance$UCoverM, na.rm = TRUE, finite = TRUE), "lightblue"),
                  backgroundSize = '100% 90%',
                  backgroundRepeat = 'no-repeat',
                  backgroundPosition = 'center') %>%
      formatStyle('FreqM',
                  background = styleColorBar(range(fitted_importance$FreqM, na.rm = TRUE, finite = TRUE), "lightgrey"),
                  backgroundSize = '100% 90%',
                  backgroundRepeat = 'no-repeat',
                  backgroundPosition = 'center') %>%
      formatStyle("BGainSD",
                  background = styleColorBar(range(fitted_importance$BGainSD, na.rm = TRUE, finite = TRUE), "pink"),
                  backgroundSize = '100% 90%',
                  backgroundRepeat = 'no-repeat',
                  backgroundPosition = 'center') %>%
      formatStyle("UGainSD",
                  background = styleColorBar(range(fitted_importance$UGainSD, na.rm = TRUE, finite = TRUE), "pink"),
                  backgroundSize = '100% 90%',
                  backgroundRepeat = 'no-repeat',
                  backgroundPosition = 'center') %>%
      formatStyle("BCoverSD",
                  background = styleColorBar(range(fitted_importance$BCoverSD, na.rm = TRUE, finite = TRUE), "pink"),
                  backgroundSize = '100% 90%',
                  backgroundRepeat = 'no-repeat',
                  backgroundPosition = 'center') %>%
      formatStyle("UCoverSD",
                  background = styleColorBar(range(fitted_importance$UCoverSD, na.rm = TRUE, finite = TRUE), "pink"),
                  backgroundSize = '100% 90%',
                  backgroundRepeat = 'no-repeat',
                  backgroundPosition = 'center') %>%
      formatStyle("FreqSD",
                  background = styleColorBar(range(fitted_importance$FreqSD, na.rm = TRUE, finite = TRUE), "pink"),
                  backgroundSize = '100% 90%',
                  backgroundRepeat = 'no-repeat',
                  backgroundPosition = 'center') %>%
      formatPercentage(columns = c("BGainM", "UGainM", "BGainSD", "UGainSD", "BCoverM", "UCoverM", "BCoverSD", "UCoverSD", "FreqM", "FreqSD"),
                       digits = 6)
  }
}
```

## Plotting Statistics (plots = `r plots`)

```{r Plots1, fig.height=12, fig.width=12}
if (plots) {
  fitted_in <- numeric(0)
  fitted_out <- numeric(0)
  folded <- numeric(0)
  for (i in 1:length(folds)) {
    fitted_in <- c(fitted_in, fitted_values[[i]])
    fitted_out <- c(fitted_out, fitted_predicted[[i]])
    folded <- c(folded, rep(i, length(folds[[i]])))
  }
  print(xyplot(fitted_out ~ fitted_in, group = folded, data = data.frame(Folds = as.factor(folded), Fitted = fitted_in, Predicted = fitted_out), auto.key = list(space = "right"), main = "Cross-Validated xgboost fitted values vs predicted values", xlab = "Fitted Values", ylab = "Predicted Values"))
}
```

```{r Plots2, fig.height=12, fig.width=12}
if (plots) {
  for (i in 1:length(folds)) {
    plot(x = fitted_values[[i]], y = fitted_predicted[[i]], main = paste0("Cross-Validated (fold ", sprintf(paste0("%0", floor(log10(length(folds))) + 1, "d"), i), ") xgboost fitted values vs predicted values"), xlab = "Fitted Values", ylab = "Predicted Values")
  }
}
```

```{r Plots3, fig.height=12, fig.width=12}
if (plots & classification) {
  par(mfrow=c(3, 2))
  for (i in 1:length(folds)) {
    plotting.max_f1(fitted_predicted[[i]], fitted_values[[i]], plots = TRUE, main = paste0("F1 Score (fold ", sprintf(paste0("%0", floor(log10(length(folds))) + 1, "d"), i), ")"), xlab = "Predicted Value", ylab = "F1 Score")
    plotting.max_mcc(fitted_predicted[[i]], fitted_values[[i]], plots = TRUE, main = paste0("MCC (fold ", sprintf(paste0("%0", floor(log10(length(folds))) + 1, "d"), i), ")"), xlab = "Predicted Value", ylab = "Matthews Correlation Coefficient")
    plotting.max_sensitivity(fitted_predicted[[i]], fitted_values[[i]], plots = TRUE, main = paste0("TPR (fold ", sprintf(paste0("%0", floor(log10(length(folds))) + 1, "d"), i), ")"), xlab = "Predicted Value", ylab = "True Positive Rate")
    plotting.max_specificity(fitted_predicted[[i]], fitted_values[[i]], plots = TRUE, main = paste0("TNR Score (fold ", sprintf(paste0("%0", floor(log10(length(folds))) + 1, "d"), i), ")"), xlab = "Predicted Value", ylab = "True Negative Rate")
    plotting.max_fallout(fitted_predicted[[i]], fitted_values[[i]], plots = TRUE, main = paste0("FPR Score (fold ", sprintf(paste0("%0", floor(log10(length(folds))) + 1, "d"), i), ")"), xlab = "Predicted Value", ylab = "False Positive Rate")
    plotting.max_missrate(fitted_predicted[[i]], fitted_values[[i]], plots = TRUE, main = paste0("FNR Score (fold ", sprintf(paste0("%0", floor(log10(length(folds))) + 1, "d"), i), ")"), xlab = "Predicted Value", ylab = "False Negative Rate")
  }
}
```

We can reset the printing options and leave away.

```{r PostPrint}
options(max.print = previousLimit)
options(scipen = previousScipen)
```

